import { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, SkipForward, Trophy, Flame, RefreshCw } from 'lucide-react';

const FitnessWorkout = () => {
  const [screen, setScreen] = useState('setup');
  const [currentExerciseIndex, setCurrentExerciseIndex] = useState(0);
  const [currentRound, setCurrentRound] = useState(1);
  const [currentRep, setCurrentRep] = useState(0);
  const [totalRounds, setTotalRounds] = useState(3);
  const [repsPerExercise, setRepsPerExercise] = useState(10);
  const [isPaused, setIsPaused] = useState(false);
  const [restTimeRemaining, setRestTimeRemaining] = useState(30);
  const [countdown, setCountdown] = useState(3);
  const [showCountdown, setShowCountdown] = useState(false);
  const [totalRepsCompleted, setTotalRepsCompleted] = useState(0);
  const [voiceEnabled, setVoiceEnabled] = useState(true);
  const [soundEffectsEnabled, setSoundEffectsEnabled] = useState(true);
  const [isFirstExercise, setIsFirstExercise] = useState(true);
  
  // Voice system refs
  const audioCache = useRef(new Map());
  const hasSpokenRef = useRef<Record<string, boolean>>({});
  const isCurrentlySpeaking = useRef(false);
  const audioContextRef = useRef<AudioContext | null>(null);
  const audioInitialized = useRef(false);
  const speechSynthRef = useRef<SpeechSynthesis | null>(null);
  const useElevenLabs = useRef(true);

  const exercises = [
    {
      name: 'Push-ups',
      voiceName: 'Push ups',
      instruction: 'Keep your body straight, chest to ground',
      restAfter: 30,
      targetMuscles: 'Chest, Arms, Core',
      midpointCue: 'Keep good form',
      midpointTime: 6
    },
    {
      name: 'Sit-ups',
      voiceName: 'Sit ups',
      instruction: 'Hands behind head, engage your core',
      restAfter: 30,
      targetMuscles: 'Abs, Core',
      midpointCue: 'Keep that core engaged',
      midpointTime: 7
    },
    {
      name: 'Jumping Jacks',
      voiceName: 'Jumping Jacks',
      instruction: 'Jump with arms overhead, land softly',
      restAfter: 30,
      targetMuscles: 'Full Body, Cardio',
      midpointCue: 'Land softly',
      midpointTime: 6
    },
    {
      name: 'Bodyweight Squats',
      voiceName: 'Squats',
      instruction: 'Keep chest up, knees over toes',
      restAfter: 45,
      targetMuscles: 'Legs, Glutes, Core',
      midpointCue: 'Chest up',
      midpointTime: 6
    }
  ];

  const currentExercise = exercises[currentExerciseIndex];

  // Initialize audio context and speech synthesis
  const initializeAudio = async () => {
    if (audioInitialized.current) return;
    
    try {
      const AudioContext = window.AudioContext || (window as any).webkitAudioContext;
      const audioContext = new AudioContext();
      audioContextRef.current = audioContext;
      
      if (audioContext.state === 'suspended') {
        await audioContext.resume();
      }
      
      if (window.speechSynthesis) {
        speechSynthRef.current = window.speechSynthesis;
      }
      
      audioInitialized.current = true;
      console.log('âœ… Audio initialized');
    } catch (e) {
      console.warn('Audio initialization failed:', e);
    }
  };

  // Play audio blob (ElevenLabs)
  const playAudioBlob = async (blob: Blob): Promise<void> => {
    return new Promise<void>((resolve, reject) => {
      try {
        const audioUrl = URL.createObjectURL(blob);
        const audio = new Audio(audioUrl);
        
        audio.volume = 1.0;
        audio.preload = 'auto';
        
        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          isCurrentlySpeaking.current = false;
          resolve();
        };

        audio.onerror = (error) => {
          URL.revokeObjectURL(audioUrl);
          isCurrentlySpeaking.current = false;
          reject(error);
        };

        audio.play().catch(error => {
          URL.revokeObjectURL(audioUrl);
          isCurrentlySpeaking.current = false;
          reject(error);
        });
      } catch (error) {
        isCurrentlySpeaking.current = false;
        reject(error);
      }
    });
  };

  // Browser speech synthesis fallback
  const speakWithBrowser = async (text: string): Promise<void> => {
    return new Promise<void>((resolve, reject) => {
      if (!speechSynthRef.current) {
        reject(new Error('Speech synthesis not available'));
        return;
      }

      try {
        if (speechSynthRef.current.speaking) {
          speechSynthRef.current.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;

        utterance.onend = () => {
          isCurrentlySpeaking.current = false;
          resolve();
        };

        utterance.onerror = (error) => {
          isCurrentlySpeaking.current = false;
          console.error('Browser speech error:', error);
          reject(error);
        };

        speechSynthRef.current.speak(utterance);
      } catch (error) {
        isCurrentlySpeaking.current = false;
        reject(error);
      }
    });
  };

  // Main speak function with ElevenLabs + Browser fallback
  const speak = async (text: string, cacheKey: string | null = null): Promise<void> => {
    if (!voiceEnabled) return;

    while (isCurrentlySpeaking.current) {
      await new Promise(resolve => setTimeout(resolve, 50));
    }

    if (cacheKey && hasSpokenRef.current[cacheKey]) return;

    isCurrentlySpeaking.current = true;

    try {
      if (useElevenLabs.current) {
        // Check cache first
        if (cacheKey && audioCache.current.has(cacheKey)) {
          const audioBlob = audioCache.current.get(cacheKey);
          await playAudioBlob(audioBlob);
          hasSpokenRef.current[cacheKey] = true;
          return;
        }

        // Get ElevenLabs API key
        const apiKey = import.meta.env.VITE_ELEVENLABS_API_KEY;
        
        if (!apiKey) {
          console.warn('âš ï¸ Missing ElevenLabs API key, falling back to browser speech');
          throw new Error('ElevenLabs API key not configured');
        }

        const voiceId = '6OzrBCQf8cjERkYgzSg8'; // Workout voice
        
        console.log('ðŸŽ¤ Calling ElevenLabs directly:', text.substring(0, 50) + '...');
        
        const abortController = new AbortController();
        const timeoutId = setTimeout(() => {
          console.warn('â±ï¸ Request timeout after 10 seconds');
          abortController.abort();
        }, 10000);
        
        let response;
        try {
          response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': apiKey,
            },
            body: JSON.stringify({
              text: text,
              model_id: 'eleven_turbo_v2_5',
              voice_settings: {
                stability: 0.4,
                similarity_boost: 0.8,
              },
            }),
            signal: abortController.signal
          });
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            const errorText = await response.text().catch(() => 'Could not read error');
            console.error('âŒ ElevenLabs API error:', response.status, errorText);
            throw new Error(`ElevenLabs API failed: ${response.status}`);
          }
          
        } catch (fetchError: any) {
          clearTimeout(timeoutId);
          console.error('âŒ Fetch failed:', fetchError);
          throw fetchError;
        }

        console.log('ðŸ“¦ Reading audio...');
        const audioBlob = await response.blob();
        console.log('âœ… Audio received:', audioBlob.size, 'bytes');
        
        if (audioBlob.size === 0) {
          throw new Error('Audio blob is empty');
        }

        if (cacheKey) {
          audioCache.current.set(cacheKey, audioBlob);
        }

        await playAudioBlob(audioBlob);
        
        if (cacheKey) {
          hasSpokenRef.current[cacheKey] = true;
        }

      } else {
        await speakWithBrowser(text);
      }

    } catch (error) {
      console.error('âŒ ElevenLabs failed:', error);
      console.log('ðŸ”„ Falling back to browser speech...');
      
      try {
        await speakWithBrowser(text);
      } catch (fallbackError) {
        console.error('âŒ Both voice methods failed:', fallbackError);
        isCurrentlySpeaking.current = false;
      }
    }
  };

  // Whistle sound
  const playWhistle = () => {
    if (!soundEffectsEnabled) return;
    
    const whistleAudio = new Audio('/whistle.wav');
    whistleAudio.volume = 0.7;
    
    whistleAudio.play().catch(() => {
      playSynthesizedWhistle();
    });
  };

  const playSynthesizedWhistle = () => {
    try {
      const audioContext = audioContextRef.current || new (window.AudioContext || (window as any).webkitAudioContext)();
      const now = audioContext.currentTime;
      
      const createTone = (freq: number, startTime: number, duration: number, volume: number) => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        oscillator.frequency.value = freq;
        
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(volume, startTime + 0.005);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
        
        oscillator.start(startTime);
        oscillator.stop(startTime + duration);
      };
      
      createTone(3520, now, 0.18, 0.35);
    } catch (e) {
      console.warn('Whistle sound failed:', e);
    }
  };

  // Clear all caches
  const clearAllCaches = () => {
    // Clear audio cache
    audioCache.current.clear();
    // Clear spoken refs
    hasSpokenRef.current = {};
    // Cancel any ongoing speech
    if (speechSynthRef.current && speechSynthRef.current.speaking) {
      speechSynthRef.current.cancel();
    }
    isCurrentlySpeaking.current = false;
    console.log('âœ… All caches cleared');
  };

  // Clear all caches on component mount (only once)
  useEffect(() => {
    clearAllCaches();
    
    // Validate env vars
    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
    
    if (!supabaseUrl || !supabaseAnonKey) {
      console.warn('âš ï¸ Missing Supabase environment variables!');
      console.warn('VITE_SUPABASE_URL:', supabaseUrl ? 'âœ… Set' : 'âŒ Missing');
      console.warn('VITE_SUPABASE_ANON_KEY:', supabaseAnonKey ? 'âœ… Set' : 'âŒ Missing');
    } else {
      console.log('âœ… Supabase environment variables configured');
    }
  }, []);

  // âœ… Start workout with coach intro
  const startWorkout = async () => {
    await initializeAudio();
    
    setIsFirstExercise(true);
    setScreen('ready');
    setShowCountdown(false);
    setCurrentExerciseIndex(0);
    setCurrentRound(1);
    setCurrentRep(0);
    
    await speak(
      "Hi! I'm your fitness coach! Let's get to work!",
      'coach_intro'
    );
    
    setTimeout(async () => {
      await speak(`Get ready for ${exercises[0].voiceName}!`, 'exercise_0_ready');
      
      setTimeout(async () => {
        setShowCountdown(true);
        setCountdown(3);
        await speak('3', 'countdown_3');
      }, 1500);
    }, 800);
  };

  // âœ… FIXED: Countdown with perfect sync - voice THEN visual update
  useEffect(() => {
    if (screen === 'ready' && showCountdown && isFirstExercise) {
      if (countdown > 0) {
        const timer = setTimeout(async () => {
          if (countdown > 1) {
            // Speak FIRST
            await speak((countdown - 1).toString(), `countdown_${countdown - 1}`);
            // THEN update display (300ms delay for voice to start)
            setTimeout(() => {
              setCountdown(countdown - 1);
            }, 300);
          } else {
            // Countdown finished - say "Go!" then start workout
            await speak('Go!', 'go');
            if (soundEffectsEnabled) {
              setTimeout(() => playWhistle(), 200);
            }
            setTimeout(() => {
              setShowCountdown(false);
              setScreen('workout');
              setCurrentRep(1);
            }, 1000); // Give "Go!" time to finish
          }
        }, 1400); // Longer interval for better voice pacing
        return () => clearTimeout(timer);
      }
    }
  }, [screen, showCountdown, countdown, isFirstExercise, soundEffectsEnabled]);

  // âœ… FIXED: Rep progression - Better timing with voice sync
  useEffect(() => {
    if (screen === 'workout' && !isPaused && currentRep > 0 && currentRep < repsPerExercise) {
      const timer = setTimeout(async () => {
        const nextRep = currentRep + 1;
        
        // Voice coaching at last 3 reps - speak BEFORE updating visual
        if (nextRep === repsPerExercise - 2) {
          await speak('3', `last3_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => {
            setCurrentRep(nextRep);
            setTotalRepsCompleted(prev => prev + 1);
          }, 200);
        } else if (nextRep === repsPerExercise - 1) {
          await speak('2', `last2_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => {
            setCurrentRep(nextRep);
            setTotalRepsCompleted(prev => prev + 1);
          }, 200);
        } else if (nextRep === repsPerExercise) {
          await speak('1', `last1_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => {
            setCurrentRep(nextRep);
            setTotalRepsCompleted(prev => prev + 1);
          }, 200);
        } else {
          // Normal rep (no voice)
          setCurrentRep(nextRep);
          setTotalRepsCompleted(prev => prev + 1);
        }
      }, 2500); // âœ… Slower pace: 2.5 seconds per rep
      return () => clearTimeout(timer);
    }
  }, [screen, currentRep, isPaused, repsPerExercise, currentExerciseIndex, currentRound]);
  
  // Time-based midpoint coaching cues
  useEffect(() => {
    if (screen === 'workout' && !isPaused) {
      const cueTimer = setTimeout(() => {
        const cue = currentExercise.midpointCue;
        console.log(`ðŸŽ¤ Midpoint cue for ${currentExercise.name}: "${cue}" at ${currentExercise.midpointTime}s`);
        speak(cue, `midpoint_${currentRound}_${currentExerciseIndex}`);
      }, currentExercise.midpointTime * 1000);
      
      return () => clearTimeout(cueTimer);
    }
  }, [screen, isPaused, currentExerciseIndex, currentRound]);

  // Exercise completion
  useEffect(() => {
    if (screen === 'workout' && currentRep === repsPerExercise) {
      setTotalRepsCompleted(prev => prev + 1);
      
      if (soundEffectsEnabled) {
        playWhistle();
      }
      
      speak('Exercise complete! Good job!', `complete_${currentRound}_${currentExerciseIndex}`);
      
      setTimeout(() => {
        const nextExerciseIndex = currentExerciseIndex + 1;
        
        if (nextExerciseIndex < exercises.length) {
          setIsFirstExercise(false);
          setCurrentExerciseIndex(nextExerciseIndex);
          setScreen('rest');
          setRestTimeRemaining(currentExercise.restAfter);
        } else if (currentRound < totalRounds) {
          speak(`Round ${currentRound} complete! Starting round ${currentRound + 1}`, `round_${currentRound}_complete`);
          setCurrentRound(currentRound + 1);
          setCurrentExerciseIndex(0);
          setIsFirstExercise(false);
          setScreen('rest');
          setRestTimeRemaining(45);
        } else {
          speak('Workout complete! You crushed it!', 'workout_complete');
          setScreen('complete');
        }
      }, 2000);
    }
  }, [screen, currentRep, repsPerExercise, currentExerciseIndex, currentRound, totalRounds, soundEffectsEnabled]);

  // âœ… FIXED: Rest timer with perfect voice-to-visual sync
  useEffect(() => {
    if (screen === 'rest' && restTimeRemaining > 0 && !isPaused) {
      const timer = setTimeout(async () => {
        const nextExercise = exercises[currentExerciseIndex];
        
        if (restTimeRemaining === 11) {
          await speak(`Get ready for ${nextExercise.voiceName}`, `ready_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(10), 300);
        } else if (restTimeRemaining === 6) {
          await speak('5', `rest_5_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(5), 300);
        } else if (restTimeRemaining === 5) {
          await speak('4', `rest_4_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(4), 300);
        } else if (restTimeRemaining === 4) {
          await speak('3', `rest_3_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(3), 300);
        } else if (restTimeRemaining === 3) {
          await speak('2', `rest_2_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(2), 300);
        } else if (restTimeRemaining === 2) {
          await speak('1', `rest_1_${currentRound}_${currentExerciseIndex}`);
          setTimeout(() => setRestTimeRemaining(1), 300);
        } else if (restTimeRemaining === 1) {
          await speak('Go!', `go_${currentRound}_${currentExerciseIndex}`);
          if (soundEffectsEnabled) {
            setTimeout(() => playWhistle(), 200);
          }
          setTimeout(() => {
            setRestTimeRemaining(0);
            setScreen('workout');
            setCurrentRep(1);
          }, 800); // Give "Go!" time to finish
        } else {
          setRestTimeRemaining(restTimeRemaining - 1);
        }
      }, 1000);
      return () => clearTimeout(timer);
    }
  }, [screen, restTimeRemaining, isPaused, currentExerciseIndex, soundEffectsEnabled, currentRound]);

  // Skip rest
  const skipRest = () => {
    if (speechSynthRef.current && speechSynthRef.current.speaking) {
      speechSynthRef.current.cancel();
    }
    isCurrentlySpeaking.current = false;
    
    setScreen('workout');
    setCurrentRep(1);
    setRestTimeRemaining(0);
    
    if (voiceEnabled) {
      const nextExercise = exercises[currentExerciseIndex];
      speak(`Starting ${nextExercise.voiceName}`, `skip_rest_${currentRound}_${currentExerciseIndex}`).catch(() => {});
    }
  };

  // Skip exercise
  const skipExercise = () => {
    const nextExerciseIndex = currentExerciseIndex + 1;
    
    if (nextExerciseIndex < exercises.length) {
      setCurrentExerciseIndex(nextExerciseIndex);
      setScreen('rest');
      setRestTimeRemaining(currentExercise.restAfter);
      setCurrentRep(0);
    } else if (currentRound < totalRounds) {
      setCurrentRound(currentRound + 1);
      setCurrentExerciseIndex(0);
      setScreen('rest');
      setRestTimeRemaining(45);
      setCurrentRep(0);
    } else {
      setScreen('complete');
    }
  };

  // Reset workout
  const resetWorkout = () => {
    setScreen('setup');
    setCurrentExerciseIndex(0);
    setCurrentRound(1);
    setCurrentRep(0);
    setIsPaused(false);
    setTotalRepsCompleted(0);
    setIsFirstExercise(true);
    clearAllCaches();
  };

  // Setup Screen
  if (screen === 'setup') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-6">
        <div className="max-w-2xl mx-auto">
          <div className="text-center mb-8">
            <div className="inline-block p-6 bg-gradient-to-r from-orange-500 to-red-600 rounded-full mb-4">
              <Flame className="text-white" size={48} />
            </div>
            <h1 className="text-4xl font-bold text-white mb-2">Mind Brother Fitness</h1>
            <p className="text-white/70 text-lg">Let's get that work in, bro</p>
          </div>

          <div className="bg-white/10 backdrop-blur rounded-3xl p-8 mb-8">
            <h2 className="text-2xl font-bold text-white mb-6">Today's Workout</h2>
            
            <div className="grid grid-cols-2 gap-4 mb-6">
              {exercises.map((ex, idx) => (
                <div key={idx} className="bg-white/5 rounded-xl p-4">
                  <h3 className="text-white font-semibold mb-1">{ex.name}</h3>
                  <p className="text-white/60 text-sm">{ex.targetMuscles}</p>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white/10 backdrop-blur rounded-3xl p-8 mb-8">
            <div className="mb-8">
              <label className="text-white font-semibold mb-4 block">Rounds</label>
              <div className="flex items-center justify-center gap-6">
                <button
                  onClick={() => setTotalRounds(Math.max(1, totalRounds - 1))}
                  className="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl text-white text-2xl font-bold"
                >
                  -
                </button>
                <div className="text-5xl font-bold text-white w-20 text-center">
                  {totalRounds}
                </div>
                <button
                  onClick={() => setTotalRounds(Math.min(10, totalRounds + 1))}
                  className="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl text-white text-2xl font-bold"
                >
                  +
                </button>
              </div>
            </div>

            <div className="mb-8">
              <label className="text-white font-semibold mb-4 block">Reps per Exercise</label>
              <div className="flex items-center justify-center gap-6">
                <button
                  onClick={() => setRepsPerExercise(Math.max(5, repsPerExercise - 5))}
                  className="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl text-white text-2xl font-bold"
                >
                  -
                </button>
                <div className="text-5xl font-bold text-white w-24 text-center">
                  {repsPerExercise}
                </div>
                <button
                  onClick={() => setRepsPerExercise(Math.min(50, repsPerExercise + 5))}
                  className="w-14 h-14 bg-white/10 hover:bg-white/20 rounded-xl text-white text-2xl font-bold"
                >
                  +
                </button>
              </div>
            </div>
          </div>

          <div className="flex items-center justify-between bg-white/5 rounded-2xl p-6 mb-4">
            <span className="text-white font-semibold">Voice Coaching</span>
            <button
              onClick={() => setVoiceEnabled(!voiceEnabled)}
              className={`relative w-16 h-8 rounded-full transition-all ${
                voiceEnabled ? 'bg-green-500' : 'bg-white/20'
              }`}
            >
              <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${
                voiceEnabled ? 'left-9' : 'left-1'
              }`} />
            </button>
          </div>

          <div className="flex items-center justify-between bg-white/5 rounded-2xl p-6 mb-8">
            <span className="text-white font-semibold">Sound Effects (Whistle)</span>
            <button
              onClick={() => setSoundEffectsEnabled(!soundEffectsEnabled)}
              className={`relative w-16 h-8 rounded-full transition-all ${
                soundEffectsEnabled ? 'bg-green-500' : 'bg-white/20'
              }`}
            >
              <div className={`absolute top-1 w-6 h-6 bg-white rounded-full transition-all ${
                soundEffectsEnabled ? 'left-9' : 'left-1'
              }`} />
            </button>
          </div>

          <button
            onClick={startWorkout}
            className="w-full py-8 rounded-2xl font-bold text-xl shadow-lg transition-all flex items-center justify-center gap-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white hover:shadow-xl"
          >
            <Play size={28} />
            Start Workout
          </button>

          <button
            onClick={clearAllCaches}
            className="w-full py-3 rounded-2xl font-semibold text-sm transition-all flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-white/70 hover:text-white mt-4"
          >
            <RefreshCw size={16} />
            Clear Cache
          </button>

          <div className="text-center text-white/50 text-sm mt-4">
            Total: {totalRounds * exercises.length * repsPerExercise} reps Â· ~{Math.ceil(totalRounds * 8)} minutes
          </div>
        </div>
      </div>
    );
  }

  // Ready/Countdown Screen
  if (screen === 'ready') {
    if (showCountdown && isFirstExercise) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center">
          <div className="text-center">
            <h2 className="text-3xl font-bold text-white mb-8">{currentExercise.name}</h2>
            <div className="text-9xl font-bold text-white mb-8 animate-pulse">
              {countdown > 0 ? countdown : 'GO!'}
            </div>
            <p className="text-xl text-white/70">{currentExercise.instruction}</p>
          </div>
        </div>
      );
    }
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center">
        <div className="text-center">
          <div className="inline-block p-6 bg-gradient-to-r from-orange-500 to-red-600 rounded-full mb-6 animate-pulse">
            <Flame className="text-white" size={64} />
          </div>
          <h2 className="text-3xl font-bold text-white mb-4">Get Ready!</h2>
          <p className="text-xl text-white/70">Your coach is preparing your workout...</p>
        </div>
      </div>
    );
  }

  // Workout Screen
  if (screen === 'workout') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4 md:p-6">
        <div className="max-w-5xl mx-auto">
          <div className="flex justify-between items-center mb-6">
            <div className="text-white">
              <div className="text-sm opacity-70">Round {currentRound} of {totalRounds}</div>
              <div className="text-2xl font-bold">{currentExercise.name}</div>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setIsPaused(!isPaused)}
                className="p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white"
              >
                {isPaused ? <Play size={24} /> : <Pause size={24} />}
              </button>
              <button
                onClick={skipExercise}
                className="p-3 bg-white/10 hover:bg-white/20 rounded-xl text-white"
              >
                <SkipForward size={24} />
              </button>
            </div>
          </div>

          <div className="bg-white/5 backdrop-blur rounded-3xl p-8 mb-6">
            <div className="text-center">
              <div className="text-9xl font-bold text-white mb-6 mt-8">
                {currentRep}
              </div>
              <div className="text-4xl text-white/60 mb-12">
                of {repsPerExercise}
              </div>
              
              <div className="bg-white/10 rounded-2xl p-6 max-w-md mx-auto mb-8">
                <div className="text-white/70 text-lg mb-4">Progress</div>
                <div className="w-full bg-white/20 rounded-full h-4">
                  <div
                    className="bg-gradient-to-r from-orange-500 to-red-600 h-4 rounded-full transition-all duration-300"
                    style={{ width: `${(currentRep / repsPerExercise) * 100}%` }}
                  />
                </div>
              </div>

              <div className="mt-12 text-white/60 italic text-xl">
                "{currentExercise.instruction}"
              </div>
            </div>
          </div>

          <div className="grid grid-cols-4 gap-4">
            {exercises.map((ex, idx) => (
              <div
                key={idx}
                className={`p-4 rounded-xl text-center transition-all ${
                  idx === currentExerciseIndex
                    ? 'bg-gradient-to-r from-orange-500 to-red-600 text-white scale-105'
                    : idx < currentExerciseIndex
                    ? 'bg-green-500/20 text-green-300'
                    : 'bg-white/5 text-white/40'
                }`}
              >
                <div className="font-semibold text-sm">{ex.name}</div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Rest Screen
  if (screen === 'rest') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 flex items-center justify-center p-4">
        <div className="text-center">
          <h2 className="text-4xl font-bold text-white mb-6">Rest</h2>
          <div className="text-9xl font-bold text-white mb-12 mt-8">
            {restTimeRemaining}
          </div>
          <p className="text-2xl text-white/70 mb-12">
            Next: {exercises[currentExerciseIndex]?.name}
          </p>
          <div className="flex gap-4 justify-center">
            <button
              onClick={skipRest}
              className="px-8 py-4 bg-white/10 hover:bg-white/20 rounded-2xl text-white font-semibold"
            >
              Skip Rest
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Complete Screen
  if (screen === 'complete') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-green-900 to-slate-900 p-6 flex items-center justify-center">
        <div className="max-w-2xl w-full bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl text-center">
          <div className="inline-block p-6 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-full mb-6">
            <Trophy className="text-white" size={64} />
          </div>
          
          <h1 className="text-5xl font-bold text-white mb-4">Workout Complete!</h1>
          <p className="text-2xl text-white/80 mb-8">You crushed it, bro! ðŸ’ª</p>

          <div className="grid grid-cols-3 gap-4 mb-8">
            <div className="bg-white/5 rounded-2xl p-6">
              <div className="text-4xl font-bold text-white mb-2">{totalRounds}</div>
              <div className="text-white/60">Rounds</div>
            </div>
            <div className="bg-white/5 rounded-2xl p-6">
              <div className="text-4xl font-bold text-white mb-2">{totalRepsCompleted}</div>
              <div className="text-white/60">Total Reps</div>
            </div>
            <div className="bg-white/5 rounded-2xl p-6">
              <div className="text-4xl font-bold text-white mb-2">4</div>
              <div className="text-white/60">Exercises</div>
            </div>
          </div>

          <div className="flex gap-4 justify-center">
            <button
              onClick={resetWorkout}
              className="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white rounded-2xl font-bold flex items-center gap-2"
            >
              <RotateCcw size={20} />
              Do Another Workout
            </button>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

export default FitnessWorkout;